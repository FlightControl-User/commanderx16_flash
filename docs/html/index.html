<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Commander X16 ROM Flash Utility: cx16-rom-flash.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Commander X16 ROM Flash Utility<span id="projectnumber">&#160;1.0</span>
   </div>
   <div id="projectbrief">This program flashes the ROM of the Commander X16 with a new ROM.BIN file.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title"><a class="el" href="cx16-rom-flash_8c.html">cx16-rom-flash.c</a> </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >COMMANDER X16 ROM FLASH UTILITY</p><dl class="section author"><dt>Author</dt><dd>Sven Van de Velde (<a href="https://www.commanderx16.com/forum/index.php?/profile/1249-svenvandevelde/">https://www.commanderx16.com/forum/index.php?/profile/1249-svenvandevelde/</a>) </dd>
<dd>
Wavicle from CX16 forums (<a href="https://www.commanderx16.com/forum/index.php?/profile/1585-wavicle/">https://www.commanderx16.com/forum/index.php?/profile/1585-wavicle/</a>) </dd></dl>
<p>Please find below some technical details how this flash ROM utility works, for those who are interested.</p>
<p >This flash utility can be used to flash a new ROM.BIN into ROM banks of the COMMANDER X16. ROM upgrades for the CX16 will come as ROM.BIN files, and will probably be downloadable from a dedicated location. <br  />
 Because the ROM.BIN files are significantly large binaries, ROM flashing will only be possible from the SD card. Therefore, this utility follows a simple and lean upload and flashing design, keeping it as simple as possible. The utility program is to be placed onto a folder on the SD card, together with the ROM.BIN file. The user can then simply load the program and run it from the SD card folder to flash the ROM.</p>
<p >The main principles of ROM flashing is to <b>unlock the ROM</b> for flashing following pre-defined read/write sequences defined by the manufacturer of the chip. Once these sequences have been correctly initiated, a byte can be written at a specified ROM address. And this is where it got tricky and interesting concerning the COMMANDER X16 <br  />
 address bus and architecture, to develop a COMMANDER X16 program that allows the flashing onto the hardware itself.</p>
<h1><a class="anchor" id="autotoc_md0"></a>
ROM Adressing</h1>
<p >The addressing of the ROM chips follow 19 bit wide addressing mode, and is implemented on the CX16 in a special way. <br  />
 The CX16 has 32 banks ROM of 16KB each, so it implements a banking solution to address the 19 bit wide ROM address, where the most significant 5 bits of the 19 bit wide ROM address are configured through zero page $01, configuring one of the 32 ROM banks, while the CX16 main address bus is used to addresses the remaining 14 bits of the 19 bit ROM address.</p>
<p >This results in the following architecture, where this flashing program uses a combination of setting the ROM bank and using the main address bus to select the 19 bit wide ROM addresses.</p>
<pre class="fragment">                              +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+  
                              | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
                              | 8 | 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 | 9 | 8 | 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 |
                              +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+  
                              | BANK (ZP $01)     | MAIN ADDRESS BUS (+ $C000)                            |
                              +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+  
 ROM_BANK_MASK  0x7C000       | 1 | 1 | 1 | 1 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
                              +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+  
 ROM_PTR_MASK   0x03FFF       | 0 | 0 | 0 | 0 | 0 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 |
                              +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+  
</pre><p> Designing this program, there was also one important caveat to keep in mind ... What does the 6502 CPU see? <br  />
 The CPU uses zero page $01 to set the ROM banks, but the lower 14 bits of the 19 bit wide ROM address is visible for the CPU starting at address $C000 and ending at $FFFF (16KB), as the CPU uses a 16 bit address bus! So the lower 14 bits of the ROM address requires the addition of $C000 to reach the correct memory in the ROM by the CPU!</p>
<h1><a class="anchor" id="autotoc_md1"></a>
Flashing the ROM</h1>
<p >ROM flashing is done by executing specific write sequences at specific addresses into the ROM, with specific bytes. Depending on the write sequence, a specific ROM flashing functions are selected. <br  />
</p>
<p >This utility uses the following ROM flashing sequences (there are more available):</p>
<ul>
<li>Reading the ROM manufacturer and device ID information.</li>
<li>Clearing a ROM sector (filling with FF). Each ROM sector is 1KB wide.</li>
<li>Flashing the cleared ROM sector with new ROM bytes.</li>
</ul>
<p >That's it, simple and easy, but there is more to it than this ...</p>
<h1><a class="anchor" id="autotoc_md2"></a>
ROM flashing approach</h1>
<p >The ROM flashing requires a specific approach, as you need to keep in mind that while flashing ROM, there is <b>no ROM available</b>! This utility flashes the ROM in four steps:</p>
<ol type="1">
<li>Read the complete ROM.BIN file from the SD card into (banked) RAM.</li>
<li>Flash the ROM from (banked) RAM.</li>
<li>Verify that the ROM has been correctly flashed (still TODO).</li>
<li>Reset and reboot the COMMANDER X16 using the new ROM state.</li>
</ol>
<p >During and after ROM flash (from step 2), there cannot be any user interaction anymore and all interrupts must be disabled! The screen writing that you see during flashing is executed directly from the program into the VERA, as no ROM screen IO functions can be used anymore.</p>
<dl class="section version"><dt>Version</dt><dd>0.1 </dd></dl>
<dl class="section date"><dt>Date</dt><dd>2022-10-16</dd></dl>
<dl class="section copyright"><dt>Copyright</dt><dd>Copyright (c) 2022 </dd></dl>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5 </li>
  </ul>
</div>
</body>
</html>
