COMMANDER X16 ROM FLASH UTILITY\begin{DoxyAuthor}{Author}
Sven Van de Velde (\href{mailto:sven.van.de.velde@telenet.be}{\texttt{ sven.\+van.\+de.\+velde@telenet.\+be}})
\end{DoxyAuthor}
Please find below some technical details how this flash ROM utility works, for those who are interested.

This flash utility can be used to flash a new ROM.\+BIN into ROM banks of the COMMANDER X16. ROM upgrades for the CX16 will come as ROM.\+BIN files, and will probably be downloadable from a dedicated location. ~\newline
 Because the ROM.\+BIN files are significantly large binaries, ROM flashing will only be possible from the SD card. Therefore, this utility follows a simple and lean upload and flashing design, keeping it as simple as possible. The utility program is to be placed onto a folder on the SD card, together with the ROM.\+BIN file. The user can then simply load the program and run it from the SD card folder to flash the ROM.

The main principles of ROM flashing is to {\bfseries{unlock the ROM}} for flashing following pre-\/defined read/write sequences defined by the manufacturer of the chip. Once these sequences have been correctly initiated, a byte can be written at a specified ROM address. And this is where it got tricky and interesting concerning the COMMANDER X16 ~\newline
 address bus and architecture, to develop a COMMANDER X16 program that allows the flashing onto the hardware itself.\hypertarget{index_autotoc_md1}{}\doxysection{ROM Adressing}\label{index_autotoc_md1}
The addressing of the ROM chips follow 19 bit wide addressing mode, and is implemented on the CX16 in a special way. ~\newline
 The CX16 has 32 banks ROM of 16KB each, so it implements a banking solution to address the 19 bit wide ROM address, where the most significant 5 bits of the 19 bit wide ROM address are configured through zero page \$01, configuring one of the 32 ROM banks, while the CX16 main address bus is used to addresses the remaining 14 bits of the 19 bit ROM address.

This results in the following architecture, where this flashing program uses a combination of setting the ROM bank and using the main address bus to select the 19 bit wide ROM addresses.

\begin{DoxyVerb}                              +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+  
                              | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
                              | 8 | 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 | 9 | 8 | 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 |
                              +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+  
                              | BANK (ZP $01)     | MAIN ADDRESS BUS (+ $C000)                            |
                              +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+  
 ROM_BANK_MASK  0x7C000       | 1 | 1 | 1 | 1 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
                              +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+  
 ROM_PTR_MASK   0x03FFF       | 0 | 0 | 0 | 0 | 0 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 |
                              +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+  
\end{DoxyVerb}
 Designing this program, there was also one important caveat to keep in mind ... What does the 6502 CPU see? ~\newline
 The CPU uses zero page \$01 to set the ROM banks, but the lower 14 bits of the 19 bit wide ROM address is visible for the CPU starting at address \$\+C000 and ending at \$\+FFFF (16KB), as the CPU uses a 16 bit address bus! So the lower 14 bits of the ROM address requires the addition of \$\+C000 to reach the correct memory in the ROM by the CPU!\hypertarget{index_autotoc_md2}{}\doxysection{Flashing the ROM}\label{index_autotoc_md2}
ROM flashing is done by executing specific write sequences at specific addresses into the ROM, with specific bytes. Depending on the write sequence, a specific ROM flashing functions are selected. ~\newline


This utility uses the following ROM flashing sequences (there are more available)\+:


\begin{DoxyItemize}
\item Reading the ROM manufacturer and device ID information.
\item Clearing a ROM sector (filling with FF). Each ROM sector is 1KB wide.
\item Flashing the cleared ROM sector with new ROM bytes.
\end{DoxyItemize}

That\textquotesingle{}s it, simple and easy, but there is more to it than this ...\hypertarget{index_autotoc_md3}{}\doxysection{ROM flashing approach}\label{index_autotoc_md3}
The ROM flashing requires a specific approach, as you need to keep in mind that while flashing ROM, there is {\bfseries{no ROM available}}! This utility flashes the ROM in four steps\+:


\begin{DoxyEnumerate}
\item Read the complete ROM.\+BIN file from the SD card into (banked) RAM.
\item Flash the ROM from (banked) RAM.
\item Verify that the ROM has been correctly flashed (still TODO).
\item Reset and reboot the COMMANDER X16 using the new ROM state.
\end{DoxyEnumerate}

During and after ROM flash (from step 2), there cannot be any user interaction anymore and all interrupts must be disabled! The screen writing that you see during flashing is executed directly from the program into the VERA, as no ROM screen IO functions can be used anymore.

\begin{DoxyVersion}{Version}
0.\+1 
\end{DoxyVersion}
\begin{DoxyDate}{Date}
2022-\/10-\/16
\end{DoxyDate}
\begin{DoxyCopyright}{Copyright}
Copyright (c) 2022 
\end{DoxyCopyright}
